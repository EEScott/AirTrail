# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

AirTrail is a personal flight tracking web application. Users log flights, view them on an interactive world map, see statistics, and import from services like MyFlightRadar24, App in the Air, JetLog, TripIt, Flighty, and byAir. Supports multiple users with OAuth.

## Development Commands

```bash
bun setup            # First-time: install deps, start DB, migrate, seed, dev server
bun d                # Daily dev: install deps, start DB, migrate, dev server
bun run dev          # Just the Vite dev server (assumes DB is running)
bun run build        # Production build
```

**Testing:**
```bash
bun test:unit              # Vitest unit tests (src/)
bun test:unit:watch        # Vitest in watch mode
bun test:e2e               # Playwright E2E (builds + runs against port 3000)
bun test:e2e:dev           # E2E with DB reset (destructive!)
```

**Code quality:**
```bash
bun run lint         # Prettier check
bun run format       # Prettier auto-format
```

**Database:**
```bash
bun run db:migrate-dev      # Create/apply Prisma migrations (dev)
bun run db:migrate-deploy   # Apply migrations (production)
bun run db:push             # Push schema without migration files
bun run db:seed             # Seed database
bun run db:reset            # Reset database (destructive)
```

**Docker (development stack):**
```bash
bun run dx:up        # Start PostgreSQL container
bun run dx:down      # Stop PostgreSQL container
```

## Tech Stack

- **Framework:** SvelteKit (Svelte 5 with runes) + TypeScript
- **Runtime/Package Manager:** Bun
- **Styling:** Tailwind CSS v4
- **UI Components:** Bits UI + Melt UI (shadcn-svelte pattern), components in `src/lib/components/ui/`
- **Maps:** MapLibre GL + Deck.gl + svelte-maplibre
- **API:** tRPC v10 with trpc-svelte-query (TanStack Query)
- **Database:** PostgreSQL 16, Prisma (schema/migrations), Kysely (type-safe queries)
- **Auth:** Lucia v3 with Argon2 password hashing + OpenID Connect OAuth
- **Forms:** sveltekit-superforms + formsnap + Zod validation
- **Build:** Vite, adapter: svelte-adapter-bun

## Architecture

### Client-Server Data Flow
SSR is disabled (`src/routes/+layout.ts` exports `ssr = false`). The root layout server load (`src/routes/+layout.server.ts`) hydrates tRPC data to the client, loads the authenticated user, and handles auth redirects. Client-side state uses Svelte 5 runes (`$state`) in `src/lib/state.svelte.ts`.

### tRPC Layer
- **Router definition:** `src/lib/server/routes/_app.ts` composes sub-routers (user, flight, airport, airline, aircraft, oauth, autocomplete, share, visitedCountries, sql)
- **Procedures:** `src/lib/server/trpc.ts` defines `publicProcedure`, `authedProcedure`, `adminProcedure`, `ownerProcedure`
- **Server utilities:** `src/lib/server/utils/` — business logic for each domain
- **Client integration:** `src/lib/trpc/` — tRPC client + custom devalue transformer
- **Endpoint:** `/api/trpc/[...trpc]`

### Database Layer
- **Schema:** `prisma/schema.prisma` (source of truth)
- **Kysely types:** Auto-generated by prisma-kysely into `src/lib/db/schema.d.ts`
- **Connection:** `src/lib/db/index.ts` — Kysely instance with CamelCasePlugin (auto snake_case ↔ camelCase)
- **Queries:** Write queries using Kysely (`db` export), not raw SQL or Prisma client

### Key Directories
- `src/lib/components/` — UI components organized by feature (map, modals, display, dock, form-fields, flight-filters, onboarding)
- `src/lib/server/routes/` — tRPC routers (one per domain)
- `src/lib/server/utils/` — Server-side business logic
- `src/lib/import/` — Flight data importers (one file per provider)
- `src/lib/stats/` — Statistics aggregation logic
- `src/lib/zod/` — Shared Zod validation schemas
- `src/routes/` — SvelteKit pages and API routes
- `tests/e2e/` — Playwright tests with factories, fixtures, and helpers
- `docs/` — Separate Next.js documentation site

### Authentication
Lucia handles sessions stored in PostgreSQL. Three roles: `owner`, `admin`, `user`. OAuth via OpenID Connect is configurable through app config. Auth setup flow: first user gets `owner` role via `/setup` page.

## Code Style

- 2-space indentation, semicolons, single quotes, trailing commas
- Prettier + ESLint (flat config with svelte and import-order rules)
- Conventional commits required: `feat:`, `fix:`, `docs:`, `chore:`, `test:`, `refactor:`

## Environment Setup

Copy `.env.example` to `.env`. For local dev, set `ORIGIN=http://localhost:5173` and change `db` to `localhost` in `DB_URL`. Default seed user: `test` / `password`.
